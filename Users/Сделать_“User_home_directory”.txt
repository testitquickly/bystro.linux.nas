Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-02-03T02:00:34+02:00

====== Сделать “User home directory” ======

Надо определиться с место для отдельного каталога для хранения пользовательских данных. Тот же Midnight Commander (как и прочие программы)  должен куда-то записывать свои конфиги, а делать это на системный диск (ssd там или hdd) не разрешается.

Общий каталог для пользователей можно назвать “''users''” (логично же). 

Три раза внимательно с диском с каталогом “users”. Если он исчезнет из OMV (поломался, вынули по ошибке или заменили), при логине по ssh потеряется возможность запускать ПО от имени залогиненного юзера, пойдут ошибки “Could not chdir to home directory”. Придётся 

	1. создать нового пользователя, аналогичного основному
	2. залогиниться под новым
	3. удалить основного
	4. заново создать «основного»…

«Обновлённый» пользователь может называться теми же буквами, но у него будет другой id, и владельцем всех ранее созданных каталогов на дисках будет оставаться пользователь со старым id. Если упустить этот момент и не переназначить права на владение каталогами для юзера «со старым названием и новым id», позже могут возникнуть непонятные сложности с записью в каталоги, и подсказки не будет.

===== Где разместить каталог users? =====

Было бы здраво сделать каталог для настроек пользователей прямо на /dev/sda, бо это диск, который «случайно» не вынуть. Но в OMV каталог с профилями пользователей относится к shared folders, которые запрещено создавать на системном диске. Поэтому надо вынести каталог users на отдельный носитель. Есть несколько решений, и все они хороши, но все с какими-то последствиями.

Выбирать исходя из обстоятельств и здравого смысла.

==== 1. Отдельная партиция на системном диске ====

По-моему, отличное решение. Отдельную партиция на системном диске надо создать предварительно (хотя можно и позже, через загрузку с usb live debian или если вынуть диск и сделать всё вручную), и это в принципе норм. Но когда системный диск помрёт (а все ssd умирают ВНЕЗАПНО), то и каталог с юзер-файлами исчезнет. А последний бэкап, как всегда, окажется устаревшим.

Также миграция/апгрейд OMV станут сложнее — при переустановке надо не забыть про отдельную партицию и очень аккуратно выяснять имя второй партиции и монтировать её отдельно. И не грохнуть случайно весь раздел.

OMV-сообщество в принципе не рекомендует хранить данные на том же диске, что и система — идея OMV в том, что системный диск «жертвенный» и его легко заменить, а все данные хранятся на других носителях. Но если NAS сугубо домашний, то схема вполне рабочая, потому что при сбое ты все равно будешь с ним возиться какое-то время, и никто не будет давить «//Эй, сисадмин, скорее верни наше служебное порно…//»

==== 2. Отдельный ssd в системе ====

Если не все слоты заняты, то…

А даже если все слоты заняты, но в NAS можно воткнуть отдельную PCIe-микросхему для подключения hdd — SATA-контроллер,  HBA-карта, — тогда в системнике появится место для отдельного SSD, на котором встанет user space.

Но SATA-карта даёт только сигнал (data) к дискам, но ним еще надо подать электроэнергию из блока питания (PSU). Надо заранее проверить, есть ли свободный провод в пучке остальных. Если нет, надо еще найти разветвитель SATA-питания. Запаривать о нагрузке незачем, обычный SSD потребляет незначительно мало энергии.

А поскольку через PCIe появились новые слоты для HDD, конечно, захочется присунуть в NAS еще несколько HDD… И тогда надо будет подумать о нагрузке на питание. Если обычному SSD нужно питание 5 Вольт и не более 0.4–0.6 Ампер тока, то у HDD 3.5" питание 12 Вольт, но ему при запуске нужно ~2 Ампер (~20 Ватт), а в постоянном режиме работы ему нужно ~0.8 Ампер (~8 Ватт). Сколько всего HDD обслуживает материнская плата, столько суммарно тока должно быть способно выдать PSU. Если планируется большая нагрузка большая, возможно, ещё понадобится заменить PSU на что-то помощнее.

И надо посмотреть, будет ли новый диск расположен адекватно в корпусе, чтобы не перегревался.
 
==== 3. На постоянно воткнутую в NAS флэшку ====

Очевидное решение, если в NAS нет места под отдельный диск и никто эту флэшку даже случайно не выдернет. Для безопасности хорошо бы воткнуть её сзади.

Разумеется, скорость работы по usb всегда ниже, чем на HDD. Для нагруженного рабочего компьютера это может быть //очень// заметно. Для домашнего NAS обращение к user space незначительное, поэтому и скорость не ощущается.

**Плюсы**: при подключениях по ssh открытая сессия с обращением к HDD не даст ему уйти в сон. Когда user space на SSD, всем HDD при неактивности могут спокойно заснуть.

**Минусы**: надо регулярно делать бэкап этого раздела (rsync в обед и вечером) и быть готовым к тому, что флэшка может, как и все usb-носители, непредсказуемо сгореть или постепенно «помереть» от износа. Хорошо то, что для user space не нужны флэшки на много гигабайт, и заменить её будет легко и дешево.

В норме было бы разумно монтировать при старте компьютера партицию с флэшки в /''home'' в виде каталога /''users'', и записать это всё в ''/etc/fstab'', но в OMV нельзя напрямую редактировать ''/etc/fstab'', а user space должен находиться внутри shared folder. 

==== 4. На один из внутренних HDD ====

Простейшее решение:

* файлы профилей юзеров должны находиться на системном диске /dev/sda1 в ''/home/users''
* но мы сделаем shared folder для профилей юзеров на (например) /dev/sdd1, на котором будет сделан симлинк на/в ''/home/users/''

Эта схема безопаснее — даже если диск /dev/sdd1 умрет или будет заменен, каталог с профилями пользователей останется на месте, на новом диске будет достаточно снова сделать симлинк.

Но в принципе рекомендуется сперва рассмотреть варианты с партицией для user space на SSD или USB. Минус хранения user space на HDD в том, что когда-нибудь //надо// будет сделать физическую проверку состояния разделов на HDD ([[HDD:Минимальная защита данных]]), и если на одном из HDD будет прилинкованный user space, то такой диск будет невозможно отмонтировать внутренними силами OMV, потому что на нем находится действующий shared folder. И как ни пыхти, он будет выпадать из списка дисков, которые можно проверить. Единственное решение — только полная перезагрузка компьютера и загрузка с USB Live Debian. 

===== Сделать каталог для профилей =====

Идём по пути «постоянно воткнутая в NAS флэшка», на которой будет создан shared folder “''users''”. Партиция на флэшке, ее монтирование, настройка доступа к файлам и права пользователей — всё полностью управляются на стороне OMV.

=== Подключить флэшку ===

[[HDD:Добавить SSD]]

Три раза убедиться в том, что флэшка была корректно примонтирована через OMV.

=== Сделать shared folder “users” ===

''Storage > Shared Folders > Create''

* name = ''users''
* file system = партиция флэшки
* relative paths = ''users/''
* permissions = оставить стандартные

Зайти в //Permissions// для этого каталога и поставить галочками права Read/Write для всех юзеров и групп, которые действуют на NAS.

=== Назначить User home directory ===

''Users > Settings''

* Enabled = да
* Location = из выпадающего списка выбрать shared folder “users”

[Save].

OMV перенесет туда все «домашние каталоги» всех юзеров.

=== Проверить права на каталоги ===

''ls -ld /srv/''__''dev-disk-by-uuid-b75b5bea-8b3b-41e7-a919-3c523828ba56''__''/users/*''

У каждого каталога должен быть соответствующий владелец, а не root. При необходимости переназначить их из-под sudo (рекурсивно!).

Например, ''750'' (владелец пишет, другие читают, гости идут в лес):

''USER_NAME='astenix'; USER_FOLDER=$USER_NAME/; chown $USER_NAME:users -R $USER_FOLDER && chmod -R 750 $USER_FOLDER && echo -e "\nDone!"''

Повторить для каталога каждого аккаунта

Можно ограничить вход в «каталог не твоего профиля» через права ''700''.

===== Настроить бэкап =====

'''
Services > RSync
'''

Включить сервер RSync.

Копирование происходит в режиме «содержимое одного shared folder полностью копируется в другой shared folder».

Сделать новую задачу:

* Source shared folder = ''users [users]''
* Destination shared folder = ''main.omv-system-backup [backup,omv]''

Остальные настройки и время указать по своим предпочтениям.

//Next step//: [[Добавить пользователей]]
