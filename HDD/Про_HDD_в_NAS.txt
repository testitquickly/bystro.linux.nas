Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-01-31T20:26:36+02:00

====== Про HDD в NAS ======

Выбор дисков в NAS полностью зависит от выбранной [[Установка OMV:Настроить бэкап OMV]]

Для домашних нужд достаточно HDD от одного производителя, заранее предназначенные для работы в условиях NAS. В идеале:

* тип записи CMR
* скорость на 5400 оборотов в минуту
* таблица разделов = GPT
* файловая система = дедушкин „ext4”
* количество разделов = один (партиции на дисках в NAS не нужны)

===== Тип записи =====

В норме в NAS нужны HDD с типом записи данным CMR (Conventional Magnetic Recording) — «традиционная магнитная запись». Дорожки не перекрывают друг друга; каждая дорожка имеет свою ширину и свой зазор; можно свободно выполнять рандомную запись без переписи соседних дорожек; производительность HDD стабильная.

В погоне за объёмами появилась технология шингл-записи данных — SMR (Shingled Magnetic Recording), черепичная запись, Shingled, DM-SMR — дорожки с данными накладываются друг на друга «черепицей», частично перекрывая предыдущие. Это позволяет делать диск большей ёмкости при той же плотности пластин и размере HDD.

В SMR поверхность HDD разбита на зоны (shingled zones) — это группы магнитных дорожек, записываемых строго последовательно, одна за другой. Зоны записываются последовательно, как лента, и каждая новая дорожка частично перекрывает предыдущую. И тут появляется особенность этой технологии: чтобы изменить данные в середине зоны, диск должен перечитать большой блок (зону), изменить фрагмент и снова переписать всю зону подряд. А в обычном режиме работы это не очень хорошо:

* низкая скорость записи при рандомных операциях, особенно при «переполнении кеша» (обычно 20–30 ГБ)
* долгие паузы и фризы при переписывании зон
* непредсказуемая производительность — может писать 150–200 MB/s, а через минуту падать до 20 MB/s
* высокая нагрузка на прошивку, что проявляется при больших файлах, бэкапах, torrent, rsync, NAS

Как отличить:

* если отдельно не указан SMR, на HDD почти всегда CMR (нормальная запись)
* WD Red без суффикса “Plus” и некоторые Seagate Barracuda — всегда SMR

Диски с SMR __не подходят__ для рабочих нагрузок NAS с мелкими файлами, c RAID и ZFS. От интенсивной работы на них начинается непредсказуемая деградации массива, медленный ребилд и даже полное выпадение дисков. И для копирования большого набора данных SMR зло, запись “проваливается” до скоростей USB 2.0. 

Но HDD с SMR спокойно могут работать в NAS, если держать на них архивы или фильмы, которые записал один раз и не трогаешь годами. А ещё они замечательно работают для «холодного» хранения данных.

===== Скорость =====

It really depends…

Диски на 5400 об/мин отпадают, когда //очень// важна постоянная скорость доступа к данным.

Разумно ставить в NAS HDD на 10-20 TB, а они уже в принципе не работают на 5400 об/мин, и выбирать скорость уже не нужно.

В «домашних» сценариях NAS — это средство для хранения больших объёмов информации, а не для её оперативного сбора и раздачи, и быстродействие не нужно. Поэтому диски на 5400 об/мин //для домашнего сервера// предпочтительнее — они крутятся медленнее, а значит, работают тише. Если днём это не очень заметно, то ночью разница в работе дисков на 5400 и 7200 об/мин прям слышна-слышна. Если NAS стоит на рабочем столе, то к шуму добавим ощутимые и поэтому //неприятные вибрации// от высокой скорости раскрученных внутренностей HDD. Условное решение: «автоматическое засыпание» дисков, которые крутятся на 7200 об/мин, очень заметно уменьшает общий уровень шума NAS.

//Рабочая температура// у дисков на 7200 всегда выше, несмотря на то, что в корпуса закачивают гелий (отчего они должны при работе смешно пищать). Для охлаждения всегда нужен вентилятор, и лучше, чтобы у него были лопасти побольше обычного, а это означает ещё больше шума. Без охлаждения диски на 7200 греются ощутимо (ладонь не пострадает, но будет неприятно). Например, в ''Storage > S.M.A.R.T. > Devices'' видно, что у трех дисков на 5400 об/мин средняя температура ''32◦C'', а у диска на 7200 температура ''41◦C'', хотя к нему сейчас нет обращений.

===== Raid =====

[[Добавить RAID-массив]], да чтобы на ZFS, который нативно OMV не поддерживается и запускается только через дополнительный плагин; и чтобы памяти в сервере не меньше 16 Gb — можно, но для //домашних// нужд не нужно.

===== Label =====

[[Добавить HDD:Прописать label]] — надо обязательно. 

Метка каждого диска должна быть внятная: „''nas_red_6tb_main''” или „''nas_red_6tb_bkp''” соответственно. В корне каждого диска разумно сделать файл с названием, идентичным метке диска, в будущем это здорово поможет ориентироваться в их содержимом.

Любопытно, что Debian при разметке дисков разрешает делать метки с нижним подчеркиванием, тогда как средствами OMV запрещено прописывать такие символы, только „''nasRed6TbMain''”. А если вставить в NAS диск с уже созданной меткой вроде „''nas_red_6tb_main''” — OMV принимает его без возражений.

===== Shared folders =====

[[Shared Folders]] — шарятся всегда //каталоги//, а не диски целиком, поэтому сперва надо закатать на диски всё файло, которое будет бэкапиться и раздаваться с NAS, и основательно упорядочить его по каталогам, затем уже втыкать диски в сервер. Позже можно будет по ssh/smb что-то куда-то передвигать, но мировой порядок должен быть задан изначально.

===== Шифрование =====

См. [[Добавить HDD:Зашифровать]].

===== Права доступа =====

ACL в норме использовать [[https://wiki.omv-extras.org/doku.php?id=omv7:nas_permissions_omv7#general1|не надо]], потому что не надо смешивать стандартные механизмы ''Linux Permissions'' от Debian и ''Acess Control List'' от OMV, это может вызвать непредсказуемый батхёрт. ACL разумно использовать только когда какому-то юзеру надо ЯВНО запретить заходить в какой-то каталог.

//Next step//: [[Добавить HDD]]
