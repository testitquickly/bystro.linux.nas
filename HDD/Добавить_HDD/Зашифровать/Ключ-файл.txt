Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2025-11-07T16:23:50+02:00

====== Ключ-файл ======

Удобно открывать зашифрованную партицию на HDD через файл-ключ, чтобы не запоминать и вводить пароль от каждого криптоконтейнера, особенно если их много.

===== Разрешить юзеру NAS некоторые сверхправа =====

Не совсем секьюрно, но сперва надо будет разрешить своему юзеру на NAS выполнять некоторые команды sudo без запроса пароля. 

'''
sudo visudo
'''

Обычно открывается временный файл в редакторе //nano.//

Добавить в конце файла:

__''имя_юзера''__ ''ALL=(ALL) NOPASSWD: /sbin/shutdown, /sbin/cryptsetup, /bin/mount, /bin/umount''

Сохранить:

''Ctrl+X''

Выйти:

''Ctrl+Q''

Проверить корректность синтаксиса файла:

''sudo visudo -c''

Если в ответ OK — продолжаем.

===== Примонтировать зашифрованную партицию =====

Вручную, взять ту же ''enc_wd_red_6tb'' из «[[Зашифровать#…вручную (ssh)|Зашифровать]]».

Убедиться в том, что она стабильно иницализируется там, где ей положено; что права на запись в каталог внутри партиции есть не только у root, и вообще всё норм.

===== Создать ключ для LUKS =====

Дико несекьюрно, но можно хранить ключи на NAS:

'''
sudo mkdir -m 700 /etc/keys
'''

Можно назвать этот каталог рэндомными буквами, но путь к ключам в этом каталоге будет открыто прописан в скриптах .''sh'' в профиле юзера для быстрого/автоматического подключения криптоконтейнеров. Если уже надо по-настоящему секьюрить, то хранить файл-ключ следует вовне NAS, или на флэшке (которую легко проглотить), или на своём ноуте (который тоже должно быть легко проглотить и переварить). А если надо будет открывать контейнер прямо на NAS, то можно же с NAS на свой ноут метнуться через SCP и скопировать ключ в /tmp NAS — см. далее пример такого скрипта…

Создать ключ для криптоконтейнера методом хаотичного генерирования символов. Имя ключа задать по имени криптоконтейнера, который этот ключ будет обслуживать:

''sudo dd if=/dev/random of=/etc/keys/enc_wd_red_6tb.key bs=64 count=1''

Нормальный ответ выглядит примерно так:

''1+0 records in''
''1+0 records out''
''64 bytes copied, 0,000503045 s, 127 kB/s''

Ключ-файл с сакральной абракадаброй внутри создан.

Переключиться под ''root'' и прописать ему правильные права:

''chown root:root /etc/keys/enc_wd_red_6tb.key && chmod 600 /etc/keys/enc_wd_red_6tb.key''

===== Добавить файл-ключ в слот криптоконтейнера =====

Контейнер при этом может быть и закрыт, это нормально. Обращение к криптоконтейнеру происходит по его PARTUUID (его надо знать заранее):

''sudo cryptsetup luksAddKey /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055 /etc/keys/enc_wd_red_6tb.key''

Будет запрошена парольная фраза для криптоконтейнера и ключ будет добавлен в первый свободный слот.

//Слот// — это ячейка для хранения ключа шифрования, точнее, ключевого материала, которым открывается основной master key тома. LUKS-том имеет несколько слотов (обычно 8). 

При добавлении ключа указать слот явным номером невозможно, cryptsetup сам выбирает первый свободный. Если все слоты заняты, нужно удалить один через luksRemoveKey, чтобы освободить место.

Узнать, какой слот уже занят ключом:

''sudo cryptsetup luksDump /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055''

Например, вот так отображаются два занятых слота:

''Keyslots:''
  ''0: luks2''
		''Key:        128 bits''
		''Priority:   normal''
		''Cipher:     aes-cbc-essiv:sha256''
		''Cipher key: 128 bits''
		''… и так далее''
  ''1: luks2''
	''… и так далее''

Каждый слот может содержать разный пароль или ключевой файл, но все они дают доступ к одному и тому же зашифрованному master key. Пользователь может иметь несколько способов открыть один и тот же том: например, пароль + ключевой файл + временный пароль. Команда luksAddKey помещает указанный ключ в свободный слот.

Если удалить слот (luksKillSlot), способ доступа, лежащий в этой ячейке, перестаёт работать, остальные — нет. Если ноут украли или флэшку потеряли, надо обязательно удалить из криптоконтейнера слот, в котором был прописан потерянный ключ.

Если ключ-файл уже на ноутбуке: переместить его на NAS и выполнить с ним ''luksAddKey''.

===== Переместить ключ на ноут =====

 Любым доступным легальным способом. И сразу надо решить, где он будет лежать.

Держать такой файл-ключ можно 

* или на ноутбуке (открыто или в криптоконтейнере типа VeraCrypt)
* или в Dropbox (тоже на ноутбуке, открытый доступ)
* или в KeePassXC (секьюрнее и логичнее, чем Dropbox, но и тут для открытия нужно вводить пароль)
* или на флэшке, которую можно выдернуть и спрятать. Нет флэшки, нет ключ-файла — ничего не откроется, причём уже никак и никогда
* или на флэшке внутри криптоконтейнера.

Флэшка повышает безопасность, но надо помнить, что 

* она должна поддерживать форматирование в ext4, чтобы сохранить особые права доступа к файлу-ключу, а большинство micro sd card, особенно дешевые, поддерживают только vfat. Но если найти подходящую, то при шухере бухгалтерам будет удобнее проглотить маленькую карточку, нежели длинную флэшку usb
* в принципе можно держать файл и на micro sd card в vfat, ведь речь идет о простом текстовом файле, а вся безопасность держится на том, что карту можно не втыкать в ноут
* она постоянно теряется как раз тогда, когда она нужна
* её надо трижды забэкапить в разных частях света, а обычно их всех беспечно держат в одном месте
* она может не оказаться под рукой, если придется драпать, прихватив только ноутбук

Втыкать флэшку с файлом-ключом можно или в NAS, или в ноут. Ощущается как мелкое неудобство, но к этому быстро привыкают (начинают беспечно держать файл-ключ в Dropbox, а не на флэшке). Главное — не держать её постоянно воткнутой.

==== Прописать ключу строгие права доступа ====

Секьюрно сделать ''root'' владельцем этого файла, держать его в каталоге /root в криптоконтейнере.

Допустим, файл лежит в ''~/.keys/'':

''chmod 600 ~/.keys/enc_wd_red_6tb.key''

Код ''600'' означает ''rw'' для владельца и ничего для всех остальных. 

===== Скрипт для монтирования удаленного каталога =====

Через SSHFS. Можно и NFS, но он будет требовать shared folder, и можно его каждый раз «поднимать», но это лишнее, ведь доступ к зашифрованной партиции нужен только ненадолго.

Сделать скрипт вроде //nas-mount-enc_wd_red_6tb.sh//:

{{{code: lang="sh" linenumbers="True"
#!/bin/bash

    # монтировать локально каталог из зашифрованной партиции на NAS
    # для моего юзера на NAS уже добавлено через sudo visudo глобальное
    # разрешение на выполнение команд, которые выполняются в этом скрипте:
    # tower ALL=(ALL) NOPASSWD: /sbin/shutdown, /sbin/cryptsetup, /bin/mount, /bin/umount
    # и файл-ключ уже добавлен в слот криптоконтейнера

    # глобальный файл с переменными:
    # nas_ip
    # nas_host
    # ssh_keys
. /home/mySettings/myScripts/_variables.var

NAS_CONTAINER_HDD=/dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055
NAS_CONTAINER_NAME=enc_wd_red_6tb
NAS_MOUNT_POINT=/srv/dev-disk-by-uuid-006tbhdd-r34f-q3r4-6b78-pc45fb2ks921
NAS_FOLDER_NAME=enc_wd_red_6tb

LOCAL_ENCRYPTED_KEY_FILE=/home/mySettings/keys/nas_encrypted/enc_wd_red_6tb.key
LOCAL_MOUNT_POINT=/home/nas/enc_wd_red_6tb

    # Проверить доступность сервера
ping -c1 -W1 $nas_ip >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo -e "\n\tОшибка! $nas_ip недоступен\n"
    exit 1
fi

echo -e " "

# NAS: Передал ключ-файл в /tmp через SCP
scp -i $ssh_key $LOCAL_ENCRYPTED_KEY_FILE $nas_host:/tmp/luks.key

ssh $nas_host -i $ssh_key "sudo cryptsetup open $NAS_CONTAINER_HDD $NAS_CONTAINER_NAME --key-file=/tmp/luks.key && shred -u /tmp/luks.key"
echo -e "\n\tNAS: Открыл криптоконтейнер на NAS через ключ-файл из /tmp. Ключ сразу был уничтожен"

ssh $nas_host -i $ssh_key "sudo mount /dev/mapper/$NAS_CONTAINER_NAME $NAS_MOUNT_POINT"
echo -e "\n\tNAS: Примонтировал зашифрованную партицию в криптоконтейнер"

if sshfs -o reconnect,ServerAliveInterval=15,IdentityFile=/home/mySettings/keys/ssh/nas/nas_tower \
      $nas_host:$NAS_MOUNT_POINT/$NAS_FOLDER_NAME $LOCAL_MOUNT_POINT; then
    echo -e "\n\tФайлы доступны в $LOCAL_MOUNT_POINT \n"
else
    echo "\n\tОшибка монтирования SSHFS\n"
    exit 1
fi

}}}

===== Скрипт для размонтирования удаленного каталога =====

Сделать скрипт вроде //nas-umount-enc_wd_red_6tb.sh//:

{{{code: lang="sh" linenumbers="True"
#!/bin/bash

    # закрыть криптоконтейнер на NAS и размонтировать локальный каталог

    # глобальный файл с переменными
. /home/mySettings/myScripts/_common/variables.var

NAS_CONTAINER_NAME=enc_wd_red_6tb
LOCAL_MOUNT_POINT=/home/nas/enc_wd_red_6tb

    # Размонтировать зашифрованную партицию на NAS и закрыть LUKS
ssh $nas_host -i $ssh_key "sudo umount /dev/mapper/$NAS_CONTAINER_NAME && sudo cryptsetup close $NAS_CONTAINER_NAME"

    # Убедиться в том, что контейнер на NAS больше не существует
CONTAINER_EXISTS=$(ssh $nas_host -i $ssh_key "if [ -e /dev/mapper/$NAS_CONTAINER_NAME ]; then echo yes; else echo no; fi")

if [ "$CONTAINER_EXISTS" = "no" ]; then
    # Размонтировать локально
    sudo fusermount -u $LOCAL_MOUNT_POINT
    echo -e "\n\tNAS: криптоконтейнер закрыт.\n\tНоут: размонтирована $LOCAL_MOUNT_POINT \n"
else
    echo -e "\n\tОшибка! Криптоконтейнер на NAS ещё открыт"
    exit 1
fi

}}}

===== Разное =====

==== Если надо удалить LUKS-слот ====

Номер LUKS-слота можно узнать в любой момент до удаления, с помощью команды:

''sudo cryptsetup luksDump /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055''

 Пример ответа:

'''
LUKS header information for /dev/sdb2

Version:        2
...
Key Slot 0: ENABLED
	Iterations: 123456
	Salt: ...
Key Slot 1: ENABLED
	Iterations: 123456
	Salt: ...
Key Slot 2: DISABLED
...
'''

Каждому ключу (слоту) присвоен номер: 0, 1, 2…

ENABLED = слот активен, можно использовать
DISABLED = пустой слот

==== Если флэшка с файл-ключом потерялась ====

Сперва удалить слот, в который был записан ключ с этой карты. Узнать, какой слот соответствует этому ключу:

'''
sudo cryptsetup luksDump /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055
'''

Допустим флешка была в слоте 1 → его и удалить:

''cryptsetup luksKillSlot /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055 1''
или же
''cryptsetup luksKillSlot /dev/sdb2''

Открыть криптоконтейнер через ручной ввод пароля и создать новый слот для ключа или нового носителя:

'''
sudo cryptsetup luksAddKey /dev/disk/by-partuuid/f8c7131b-0d62-9445-9095-cdd773341055 /root/new_key.key
'''
