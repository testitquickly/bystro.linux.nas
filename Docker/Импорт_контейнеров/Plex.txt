Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2024-10-20T12:46:53+03:00

====== Plex ======

Plex когда-то был просто медиасервером, а сегодня это и сервер, и стрим-платформа на манер Netflix. Там действительно представлено много фильмов и телешоу, которые можно смотреть бесплатно со множеством рекламных вставок, которые не исчезают даже после платной подписки «Plex Pass».

===== Что надо учесть =====

==== Раздача контента ====

На Plex можно поднять [[DLNA:Plex DLNA]] и смотреть контент с телевизора, смартфонов и с ноута — в бразуере.

Но делать это с NAS сложно. Фотохостинг на NAS ещё туда-сюда, но для раздачи видео Plex нужна изрядная процессорная мощность для транскодинга. Это процесс подготовки контента к стримингу через Plex — видео надо «подгонять» под экран принимающего устройства, и (если) надо включить субтитры, то опять же нужен транскодинг, а он требует много процессорной мощности. NAS строят вокруг заведомо слабых процессоров, которые с транскодингом справляются очень плохо, кино приходится смотреть через очень «задумчивые тормоза», особенно если это полноценное fullHD с большим битрейтом, или если видео закодировано чем-то суровым вроде HEVC… 

	HEVC — High Efficiency Video Coding, также известный как H.265 — современный видеокодек, который сжимает видеофайлы эффективнее, чем H.264 (AVC). Вроде бы это делает HEVC идеальным для стриминга видео с высоким разрешением, но HEVC нуждается в мощном процессоре.

Также при просмотре видео с продвинутым кодеком можно увидеть изображение в ухудшенном качестве — сепия. Это лечится (когда видеоконтейнер с HEVC в mkv, надо проигнорировать любые настройки цвета, которые приходят от контейнера видео; также не рекомендуется ложить и класть 8-битовый контент в контейнер с HEVC; и вообще надо аккуратно выбирать видеофайлы, подготовленные для просмотра на определенных тв-устройствах), но не всегда.

Разумнее поднять сервер Plex на отдельном компьютере, если его процессор НЕ из семейства мобильных (Intel “Atom” и не arm), бо на них транскодинг в принципе невозможен. Нагрузка по транскодингу перейдёт на отдельный компьютер с быстрым процессором, а NAS будет использоваться только как хранилище контента.

Или уже поднимать NAS на мощном компьютере с современным процессором и повышенным расходом электроэнергии, где Plex будет использовать все доступные ресурсы процессора.

==== Организация фотогалереи ====

В Plex можно собрать фотографии в довольно простую фотогалерею, что условно удобно. 

Неудобности мелкие:
* для удаления фотографий нужно сделать несколько кликов
* невозможно поворачивать фотографии влево-вправо
* невозможно убрать фотографию по нажатию Esc
* просмотр фотографий сворачивается в нижний тулбар, и если вернуться в галерею и тыкать по другим фотографиям, то они подгружаются в зоне просмотра, которая свернута внизу. К этому приходится привыкать
* невозможно перемещать фотографии в другие альбомы-каталоги (это делается на hdd)

Но
* есть сортировка фотографий по альбомам (по каталогам, если точнее)
* есть хронология
* есть метки
* можно переименовывать фотографии (только в БД, оригинал не переименовывается)
* можно добавлять фотографии в «плэйлист»

	Плэйлисты для фото и видео создаются по-отдельности и не смешиваются.

	Если удалить файлы с диска, то плэйлисты остаются, только их содержимое невозможно воспроизвести «по неизвестным причинам» (В этом альбоме нет объектов). 

Альбом можно 
* переименовать (оригинальный каталог переименован не будет) 
* выбрать для него изображение-постер (будет предложено добавить его из фотографий с ноутбука; чтобы загружать изображение с сервера, надо монтировать на ноутбуке удаленный каталог с NAS).

Удалять альбомы-каталоги из Plex Web App невозможно. Можно только удалять фотографии из него. Если альбом-каталог будет удален с диска, то из базы данных Plex он будет удалён при следующем обновлении метаданных.

Всегда есть какие-то фотографии, которые ни в какой альбом не вклиниваются. Их лучше положить в каталог вроде „unsorted”.

Анимированные gif при просмотре в Plex будут статичны. Увы.

Если среди фотографий на hdd окажутся видеофайлы — они будут добавлены в Plex в раздел фотографий, и при поиске будут учитываться как фотографии. А при открытии они будут воспроизводиться как видео. Рекомендуется найти и перенести все видеофайлы в отдельные каталоги, потому что размер видеофайлов может быть непредсказуемо огромным.

Возможно, в OMV фотографии лучше организовать через плагин “PhotoPrism” или через “LibrePhotos” (есть контейнер в Docker). Там есть слабый, но всё-таки ИИ, который может сам (изредка удачно) прочитать содержимое фотографии, распознать лица, проставить англоязычные метки и всё такое прочее.

==== Сбор информации ====

Неизвестно, какую информацию Plex собирает с NAS. Очевидно собирает служебную, и наверняка не только, ведь если он может снабжать видеофайл соответствующими тэгами, описанием и постерами, то информации он берёт изрядно. Это несколько напрягает, но можно считать это платой за удобство воспроизведения контента.

Заводить аккаунт в Plex не нужно, если для возни с видео и фото на домашнем, закрытом от мира NAS. Аккаунт нужен для раздачи контента, когда NAS открыт для внешнего доступа, и для доступа к чужим ресурсам.

Любопытно, что после каждой остановки контейнера в окне браузера, в котором был открыт Plex, будет срабатывать перенаправление на https://app.plex.tv/auth/ с предложением завести себе аккаунт на платформе. К этому можно привыкнуть. Для своего NAS заводить общий аккаунт на платформе нет необходимости.

===== Установка docker-контейнера Plex =====

Простейший способ:

''Services''
''> Compose''
''> Files''
''> + Add from example''
''> тыкнуть по полю „Example”''

Выбрать из выпадающего списка „plex”. Контейнер появится в статусе «Down».

Залогиниться на NAS под ssh с юзером //mydoker.//

''id mydoker''

Посмотреть в ответе циферки для
* uid
* gid

==== Отредактировать файл запуска ====

Кликнуть по контейнеру, затем по иконке Edit.

ports → можно не указывать, приложение будет доступно только через порт 32400.

'''
services:
  plex:
	image: lscr.io/linuxserver/plex:latest
	container_name: plex
	network_mode: host
	environment:
	  - PUID=1002
	  - PGID=100
	  - TZ=Europe/Chisinau
	  - VERSION=latest
	volumes:
	  - /etc/localtime:/etc/localtime:md
'''
						 ''- /srv/dev-disk-by-uuid-2ca…/docker/composefiles/plex/:/config''	  
'''
         - /srv/dev-disk-by-uuid-2ca…/docker/transcode:/transcode
	  - /srv/dev-disk-by-uuid-8ad…/images/:/plex/foto
	  - /srv/dev-disk-by-uuid-2ca…/v3/Юмор:/plex/video-humor
	restart: no #unless-stopped
'''

В данном случае после двоеточия объявлена переменная для контейнера, содержимое которой указано ПЕРЕД двоеточием. Можно создать несколько таких переменных вроде 
	'':/downloadsbooks''
	'':/downloads1''
	'':/downloads_2''
	'':/music''
	'':/books''
	
и из интерфейса загрузчика «перемещать» загружаемые файлы в соответствующие каталоги. Один из них должен быть установлен по-умолчанию. 

	В эпоху utf-8 вроде бы можно их именовать русскими буквами, но на деле нет, допустимы только буквы английского алфавита. В названии каталогов наоборот.
	
	Также во все эти «разные каталоги» у юзера //mydoker// должен быть доступ — или явный, или через группу, в которую он вхож, //user// или (что предпочтительнее) //sudo//.
	
	Полный путь к каталогу, в котором находишься, можно вывести на экран командой ''pwd''

Сохранить.

Тыкнуть по контейнеру, нажать кнопку Up. Начнуть скачиваться файлы и сразу проверяться. 

Если всё хорошо — появится кнопка Close и статус контейнера поменяется на Up. 

==== Открыть ====

Открыть http://MY_NAS:32400/web/ — логин и пароль. По-умолчанию ''admin/admin''

===== Настроить =====

''Настройки (в правом верхнем углу иконка гаечного ключа)''
''> Настройки''
''> Сеть''
	''Включить поддержку IPv6 сервером — ДА''
	''Предпочтительный сетевой интерфейс — выбрать локальный (192.168…)''
	''Криптостойкий TLS  — ДА''
	''Включить обнаружение в локальной сети (GDM) — ДА''
	''Включить ретрансляцию — НЕТ''
	''Вебхуки — НЕТ''
''Сохранить изменения''

===== Добавить файлы =====

Может показаться, что можно добавить файлы просто указав каталоги на hdd на NAS, но нет, это же контейнер, он «видит» только те каталоги, которые ему «объявлены» в конфиге, поэтому сперва надо сделать полный список каталогов для Plex, дать им внятные названия.

==== Видео ====

Есть [[https://support.plex.tv/articles/naming-and-organizing-your-movie-media-files/|общие советы]] о том, как организовать файлы для сканирования Plex:
* разнести контент разного типа по каталогам — они обслуживаются разными «агентами», и для каждого каталога назначается агент по типу «видео», «изображения» и тд
* каталоги с файлами с кино надо именовать так же, как файл с кино внутри каталога (вроде ''/Avatar (2009)/Avatar (2009).mkv''), это ускорит их индексирование и упростит обслуживание метаданных (описание, постер и тд),
* в одну библиотеку можно добавить несколько разных источников одного типа (например, все файлы типа «фильм» с разных hdd).
* «фильмы на дисках» (ISO, Video_TS и прочий dvd) не поддерживаются в принципе.

Для порядка можно в конфиге контейнера Plex указывать переменные через общий (условный) каталог ''plex'':

''/srv/dev-disk-by-uuid-9b3…/backup/Изображения:/plex/images''
''/srv/dev-disk-by-uuid-3b5…/v1/v1.Фильмы:/plex/kino-v1''

и так далее. 

Каждый «plex-каталог» надо добавить в базу данных вручную по-отдельности:

''Настройки (в правом верхнем углу иконка гаечного ключа)''
''> Настройки''
''> Управлять''
''> Библиотеки''
''> Добавить библиотеку''

Выбрать соответствующий тип агента.

Учесть, что в одну библиотеку можно добавить несколько разных источников одного типа, например, объединить все каталоги с файлами типа «фильм» с разных hdd.

===== Удаление контента =====

В Plex Web App это надо сперва разрешить (аккуратно, если к файлам есть доступ у разных юзеров):

''Настройки (в правом верхнем углу иконка гаечного ключа)''
''> Настройки''
''> Библиотека''
	''Разрешить удаление контента - ДА''
''Сохранить изменения''

Открыть в фотогалерее фотографию, которую надо удалить.

В меню взаимодействия с фотографией 

''тыкнуть три вертикальные точки'' 
''> Информация'' 
''> Удалить файлы''

Файл физически удаляется с hdd.

В принципе в Plex есть корзина, но в разных приложениях для Plex это реализовано по-разному. В web app корзины нет. 

===== Переименовать файл =====

Переименовывается только запись в базе про файл, на hdd файл остаётся с оригинальным названием.
